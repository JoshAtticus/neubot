<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connect Home Assistant - neubot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    .setup-container { max-width:560px;margin:60px auto;padding:32px;background:#1f1f1f;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.4); }
    .setup-header { display:flex;align-items:center;gap:16px;margin-bottom:12px; }
    .setup-header img { width:56px;height:56px; }
    .step { margin:18px 0; }
    .step-number { background:#2d6cdf;color:#fff;font-weight:600;border-radius:50%;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;margin-right:10px;font-size:13px; }
    .url-input { width:100%;padding:12px 14px;border:1px solid #333;border-radius:8px;background:#121212;color:#eee;font-size:15px; }
    .actions { margin-top:28px;display:flex;gap:12px; }
    .btn-primary { background:#2d6cdf;color:#fff;border:none;padding:12px 22px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer; }
    .btn-secondary { background:#333;color:#eee;border:none;padding:12px 22px;border-radius:8px;font-size:16px;font-weight:500;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center; }
    .status { margin-top:18px;font-size:14px;color:#bbb;min-height:18px; }
    .error { color:#ff6565; }
    .success { color:#46c46a; }
    .hint { font-size:13px;color:#888;margin-top:6px;line-height:1.4; }
    .progress-inline { display:none;align-items:center;gap:8px;margin-top:12px;font-size:14px;color:#ccc; }
    .spinner { width:14px;height:14px;border:3px solid #2d6cdf;border-right-color:transparent;border-radius:50%;animation:spin 0.7s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg);} }
  </style>
</head>
<body>
  <div class="setup-container">
    <div class="setup-header">
      <img src="https://www.home-assistant.io/images/favicon-192x192.png" alt="Home Assistant" />
      <div>
        <h1 style="margin:0;font-size:26px;">Connect Home Assistant</h1>
        <p style="margin:4px 0 0 0;color:#bbb;font-size:14px;">Two quick steps: enter your instance URL, then authorize.</p>
      </div>
    </div>

    <div class="step">
      <div><span class="step-number">1</span><strong>Enter your Home Assistant base URL</strong></div>
      <input class="url-input" id="ha-url" placeholder="https://home.example.com" autocomplete="off" />
      <div class="hint">Include protocol (http:// or https://). Do not add trailing path or /api. Example: https://home.mydomain.com</div>
      <div class="hint">Your Home Assistant instance must be accessible from the internet. Local network URLs (e.g. 192.168.x.x or http://localhost) are not supported. </div>
      <div class="hint">Don't know how to expose Home Assistant to the internet? Check out <a href="https://github.com/JoshAtticus/neubot/blob/main/home_assistant.md" target="_blank">our guide</a>.</div>
    </div>

    <div class="step">
      <div><span class="step-number">2</span><strong>Authorize neubot in Home Assistant</strong></div>
      <div class="hint">We'll open a new tab to the official Home Assistant consent screen. Approve and you'll return automatically.</div>
    </div>

    <div class="actions">
      <button class="btn-primary" id="begin-btn">Begin Authorization</button>
      <a class="btn-secondary" href="/integrations">Cancel</a>
    </div>
    <div class="progress-inline" id="progress"><div class="spinner"></div><span id="progress-text">Starting...</span></div>
    <div class="status" id="status"></div>
  </div>
<script>
(function(){
  const beginBtn = document.getElementById('begin-btn');
  const urlInput = document.getElementById('ha-url');
  const statusEl = document.getElementById('status');
  const progress = document.getElementById('progress');
  const progressText = document.getElementById('progress-text');

  function setStatus(msg, cls){ statusEl.textContent = msg; statusEl.className='status '+(cls||''); }
  function loading(on,text){ progress.style.display = on?'flex':'none'; if(text) progressText.textContent=text; beginBtn.disabled=on; }

  beginBtn.addEventListener('click', () => {
    const baseUrl = urlInput.value.trim().replace(/\/$/, '');
    if(!baseUrl){ setStatus('Please enter your base URL', 'error'); return; }
    if(!/^https?:\/\//i.test(baseUrl)){ setStatus('Base URL must start with http:// or https://', 'error'); return; }
    loading(true,'Contacting Home Assistant...');
    fetch('/api/integrations/home-assistant/start', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ base_url: baseUrl }) })
      .then(r=>r.json())
      .then(d=>{
        if(!d.success){ setStatus(d.message||'Failed to begin authorization', 'error'); loading(false); return; }
        if(d.authorize_url){ setStatus('Opening authorization window...', 'success'); window.location = d.authorize_url; }
        else { setStatus('No authorization URL returned', 'error'); loading(false); }
      })
      .catch(e=>{ console.error(e); setStatus('Network error starting authorization', 'error'); loading(false); });
  });
})();
</script>
</body>
</html>
