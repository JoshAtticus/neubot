<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrations - neubot</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
        crossorigin="anonymous">
    <link rel="icon" href="neubot-icon.svg" type="image/svg+xml">
    <script defer data-domain="neubot.joshattic.us"
        src="https://plausible.joshattic.us/js/script.file-downloads.outbound-links.js"></script>
</head>

</head>

<body>
    <div class="integrations-container">
        <a href="/" class="btn-back"><i class="fas fa-arrow-left"></i> Back to neubot</a>
        <h1>Integrations <span class="beta-tag">BETA</span></h1>
        <p class="subtitle">Connect your services to enhance neubot's capabilities</p>

        <div id="loading">Loading integrations...</div>
        <div id="error-message"></div>

        <div class="integration-card" id="ha-card" style="display:none">
            <div class="integration-logo">
                <img src="https://www.home-assistant.io/images/favicon-192x192.png" alt="Home Assistant Logo" width="64" height="64">
            </div>
            <div class="integration-details">
                <h3 class="integration-name">Home Assistant <span class="beta-tag">BETA</span></h3>
                <p class="integration-description">Link your Home Assistant instance to control lights, switches, fans, scenes and scripts with natural language (e.g. "turn on the bedroom lights").</p>
                <div class="integration-status">
                    <span class="status-indicator status-disconnected" id="ha-status-indicator"></span>
                    <span id="ha-status">Not connected</span>
                </div>
                <div class="integration-features">
                    <p>After linking you can ask neubot to:</p>
                    <ul class="feature-list">
                        <li>Turn lights on/off ("turn on the kitchen lights")</li>
                        <li>Control fans & switches</li>
                        <li>Activate scenes & run scripts</li>
                    </ul>
                </div>
                <div class="ha-link-form" id="ha-link-form">
                    <p class="note">To connect, click below and follow the twoâ€‘step setup (enter your instance URL, authorize, return).</p>
                    <a class="btn btn-connect" id="ha-link-btn" href="/home-assistant-setup.html">Connect Home Assistant</a>
                </div>
                <div class="integration-buttons" id="ha-linked" style="display:none">
                    <button class="btn btn-disconnect" id="ha-relay-refresh">Refresh Status</button>
                    <button class="btn btn-disconnect" id="ha-unlink-btn">Disconnect</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const loadingElement = document.getElementById('loading');
            const errorMessageElement = document.getElementById('error-message');
            const haCard = document.getElementById('ha-card');
            const haStatusIndicator = document.getElementById('ha-status-indicator');
            const haStatus = document.getElementById('ha-status');
            const haLinkForm = document.getElementById('ha-link-form');
            const haLinkBtn = document.getElementById('ha-link-btn');
            const haLinked = document.getElementById('ha-linked');
            const haRefresh = document.getElementById('ha-relay-refresh');
            const haUnlinkBtn = document.getElementById('ha-unlink-btn');

            // Check user authentication first
            fetch('/api/user')
                .then(response => response.json())
                .then(data => {
                    if (!data.authenticated) {
                        window.location.href = '/login';
                        return;
                    }

                    // User is authenticated, load integrations
                    loadHAStatus();
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    showError('Failed to verify authentication. Please try again.');
                });

            function loadHAStatus() {
                fetch('/api/integrations/home-assistant/status')
                    .then(response => response.json())
                    .then(data => {
                        loadingElement.style.display = 'none';
                        haCard.style.display = 'flex';
                        if (data.connected) {
                            haStatusIndicator.className = 'status-indicator status-connected';
                            haStatus.textContent = 'Connected';
                            haLinkForm.style.display = 'none';
                            haLinked.style.display = 'block';
                        } else {
                            haStatusIndicator.className = 'status-indicator status-disconnected';
                            haStatus.textContent = 'Not connected';
                            haLinkForm.style.display = 'block';
                            haLinked.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading Home Assistant status:', error);
                        loadingElement.style.display = 'none';
                        showError('Failed to load Home Assistant status. Please try refreshing the page.');
                    });
            }

            function showError(message) {
                errorMessageElement.textContent = message;
                errorMessageElement.style.display = 'block';
            }

            // Link button now navigates to dedicated setup page (no inline handler needed)

            haRefresh.addEventListener('click', loadHAStatus);
                        haUnlinkBtn.addEventListener('click', function() {
                                if(!confirm('Disconnect Home Assistant?')) return;
                                fetch('/api/integrations/home-assistant/link', { method: 'DELETE' })
                                    .then(r=>r.json()).then(d=>{ if(d.success){ loadHAStatus(); } else { showError(d.message||'Failed to disconnect'); }})
                                    .catch(e=>{ console.error(e); showError('Failed to disconnect'); });
                        });
        });
    </script>
</body>

</html>